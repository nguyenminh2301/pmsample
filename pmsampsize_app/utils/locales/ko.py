KO = {
        "title": "예후 연구 표본 크기 도구",
        "sidebar_title": "설정",
        "language": "언어 / Language",
        "mode": "방법 선택",
        "mode_riley": "방법 1: Riley 등 (분석적)",
        "mode_bayes": "방법 2: 베이지안 보증 (시뮬레이션)",
        "mode_single": "단일 시나리오",
        "mode_batch": "민감도 분석 (범위)",
        "method1_tab": "방법 1 (Riley)",
        "method2_tab": "방법 2 (Bayesian)",
        "nav_title": "탐색",
        "nav_readme": "상세 문서 (README)",
        "nav_intro": "소개 및 공식",
        "nav_calc": "표본 크기 계산기",
        "intro_heading": "환영합니다",
        "intro_text": "이 도구는 이분형 결과가 있는 임상 예측 모델 개발에 필요한 최소 표본 크기를 계산하는 데 도움을 줍니다.",
        "formula_heading": "수학적 프레임워크 (방법 1)",
        "formula_intro": "방법 1은 Riley 등이 제공한 폐쇄형 솔루션을 사용하고, 방법 2는 베이지안 MCMC 시뮬레이션을 사용합니다.",
        "sens_guide_title": "💡 민감도 분석(배치 모드) 사용법",
        "sens_guide_text": """
        - **범위**: `min-max` 형식으로 입력 (예: `0.05-0.10`). 단계가 자동으로 생성됩니다.
        - **특정 값**: 쉼표로 구분된 목록 입력 (예: `0.05, 0.10, 0.15`).
        """,
        "detail_view": "시나리오별 상세 계산 보기",
        "footer_refs": "참고문헌: Riley et al. (2018, 2020), BayesAssurance.",
        "footer_copyright": "© 2026 Prognostic Research Sample Size Tool. 학술/연구 용으로만 사용.",
        "footer_author": "작성자 및 유지 관리: Minh Nguyen (minhnt@ump.edu.vn) - Dept. of Epidemiology, Faculty of Public Health, UMP Ho Chi Minh City",
        "footer_disclaimer": "면책 조항: 임상적 보증 없음. 검증 및 해석에 대한 책임은 사용자에게 있습니다.",
        "calc_btn": "계산하기",
        "results": "결과",
        "sanity": "건전성 심사 (EPV 규칙)",
        "download_csv": "CSV 다운로드",
        "download_report": "전체 보고서 다운로드",
        "error_p": "유병률은 0과 1 사이여야 합니다.",
        "error_auc": "AUC는 0.5와 1 사이여야 합니다.",
        "error_parse": "입력을 구문 분석할 수 없습니다.",
        "riley_inputs": "입력 파라미터 (Riley)",
        "prevalence": "결과 유병률 (이벤트 발생률)",
        "prevalence_help": "이벤트가 발생한 참가자의 비율 (0 < p < 1).",
        "parameters": "예측 변수 파라미터 수 (df)",
        "parameters_help": "총 자유도 (절편 제외).",
        "shrinkage": "목표 글로벌 수축 (S)",
        "shrinkage_help": "희망하는 수축 계수 (기본값 0.9).",
        "perf_measure": "예상 성능",
        "perf_auc": "AUC (C-통계량)",
        "perf_r2": "Cox-Snell R-제곱",
        "perf_cons": "보수적 점수 (최대 R2의 15%)",
        "bayes_inputs": "시뮬레이션 설정 (베이지안 보증)",
        "dgm_settings": "데이터 생성 매커니즘",
        "sim_settings": "시뮬레이션 및 MCMC",
        "eval_settings": "평가 기준",
        "n_candidates": "후보 표본 크기 (쉼표로 구분)",
        "n_candidates_help": "테스트할 N 값 목록, 예: 500, 1000, 1500.",
        "correlation": "예측 변수 상관관계 (rho)",
        "n_sims": "N당 시뮬레이션 횟수",
        "assurance_threshold": "보증 임계값 (목표 확률)",
        "run_simulation": "베이지안 시뮬레이션 실행",
        "simulation_running": "시뮬레이션 실행 중... 시간이 걸릴 수 있습니다.",
        "assurance_result": "보증 분석",
        "mode_dev_sim": "방법 6: 개발 시뮬레이션 (빈도주의)",
        "method6_tab": "방법 6 (시뮬레이션)",
        "dev_sim_intro": "모델 개발을 위한 시뮬레이션 기반 표본 크기 (samplesizedev와 유사한 빈도주의 접근법).",
        "dev_mode_simple": "모드 A: 단순 (AUC 기반)",
        "dev_mode_custom": "모드 B: 사용자 정의 DGM",
        "target_auc": "목표 평균 AUC (C-통계량)",
        "target_auc_help": "알고리즘이 이 AUC를 달성하기 위한 베타 계수를 찾습니다.",
        "criteria_settings": "성능 기준 (통과/실패)",
        "crit_slope_mean": "평균 교정 기울기 >= 0.9",
        "crit_slope_ci": "Pr(0.9 <= 기울기 <= 1.1) >= 80%",
        "crit_auc": "평균 AUC >= 목표",
        "audit_trail": "RNG 감사 추적 (JSON)",
        "future_methods": "향후 버전에서 제공 예정...",
        "method_quick_tab": "A. 신속 / 기본",
        "quick_mode_epv": "A1: EPV / EPP 규칙 (경험적)",
        "quick_mode_risk": "A2: 기본 위험 정밀도 (CI 너비)",
        "target_epv": "목표 파라미터당 이벤트 수 (EPP)",
        "target_epv_help": "일반적인 경험적 수치는 10, 15, 20입니다. EPP가 EPV보다 선호됩니다.",
        "parameters_short": "매개변수",
        "target_epv_short": "EPP",
        "prevalence_short": "유병률",
        "subjects_short": "피험자",
        "interpretation_a1": "계산",
        "result_a1": "필요한 표본 크기",
        "epv_warning_title": "⚠️ 중요 경고",
        "epv_warning_text": "EPV/EPP는 대략적인 경험적 규칙입니다. 교정, 판별을 보장하거나 낙관주의를 방지하지 않습니다. 변수 선택 및 비선형 항에 민감합니다.",
        "ci_level": "신뢰 수준",
        "ci_half_width": "목표 반-너비 (오차 한계)",
        "ci_method": "CI 방법",
        "ci_method_wilson": "Wilson Score (권장)",
        "ci_method_wald": "Wald (단순)",
        "ci_method_cp": "Clopper-Pearson (보수적)",
        "risk_help": "특정 정밀도로 이벤트 발생률 p를 추정하기 위한 N을 계산합니다. 예측 모델 성능을 보장하지 않습니다.",
        "title_b3": "B3: 로지스틱 검정력 (Hsieh)",
        "title_b4": "B4: Cox 검정력 (Schoenfeld)",
        "interpretation": "결과 해석",
        "d8_assumptions": "**가정**: Hanley & McNeil (1982) 분산 근사치를 사용합니다. AUC에 대해 대칭적 정규 분포를 가정합니다.",
        "d8_mode_n_to_width": "N으로부터 CI 너비 계산",
        "d8_mode_width_to_n": "CI 너비로부터 필요한 N 계산",
        "d8_opt_settings": "고급 최적화 설정",
        "d8_practical_rounding": "실용적인 정수 반올림 표시",
        "d8_n_input": "표본 크기 (N)",
        "d8_width_input": "CI 너비 (합계)",
        "d8_opt_bound": "탐색 상한선",
        "d8_opt_tol": "허용 오차",
        "title_d8": "D8: AUC 정밀도 (Hanley-McNeil)",
        "d8_desc": "희망하는 정밀도(CI 너비)로 AUC를 추정하기 위한 표본 크기를 계산합니다.",
        "auc_expected": "예상 AUC (C-통계량)",
        "formulas_header": "📚 공식 및 기술적 세부 사항",
        "title_d9": "D9: 외부 검증 (맞춤형)",
        "common_inputs": "공통 파라미터",
        "search_placeholder": "방법 검색...",
        "settings": "설정",
        "footer_copyright": "© 2026 Prognostic Research Sample Size Tool. 학술/연구용 전용.",
        "footer_author": "저자 및 유지관리: Minh Nguyen (minhnt@ump.edu.vn)",
        "footer_disclaimer": "면책 조항: 임상적 보증 없음. 사용자는 결과 검증 및 해석에 대한 책임이 있습니다.",

        "intro_complete_md": """
### 환영합니다

이 앱은 임상의와 연구자가 예후 연구를 위한 최소 표본 크기를 계획하는 데 도움을 줍니다:
* 예후 인자 연구 (연관성 검출을 위한 검정력),
* 임상 예측 모델 개발 (위험 예측), 및
* 모델 검증 / 업데이트 (외부 검증, 재보정).

이 도구는 이분형 결과 (예: 사건 발생 vs 미발생) 및 일부 모듈에서는 생존 시간 결과 (Cox 비례위험)를 위해 설계되었습니다.

소스 코드 (다운로드): [https://gitlab.com/minhthiennguyen/pmsample/](https://gitlab.com/minhthiennguyen/pmsample/)

### 시작 가이드 (신규 사용자용)

#### 1. 연구 목표 명확화
* 단일 예후 인자 (연관성)를 검정하시나요?
* 예측 모델을 개발하시나요?
* 새로운 집단에서 기존 모델을 검증하시나요?

#### 2. 사건 발생률 $p$ 추정 (또는 생존분석을 위한 사건 분율)
* 가능하면 지역 병원 데이터를 우선 사용하세요 (가장 좋음).
* 불확실한 경우, 범위를 입력하고 민감도 분석을 실행하세요.

#### 3. 모델 복잡도 정확히 계산 (파라미터 / 자유도)
"변수 수"가 아닌 파라미터 (자유도)를 사용하세요.
* 이분형 예측변수: 1 df
* $L$ 수준 범주형: $L-1$ df
* 스플라인 (RCS, $K$ 매듭): $K-1$ df
* 상호작용: $df(A \\times B) = df(A) \\cdot df(B)$

#### 4. 아래 카탈로그에서 방법 선택
* **"빠른 도구"**는 대략적인 계획에만 사용하세요.
* 예측 모델 개발 시 **Riley / 시뮬레이션 / 보증** 방법을 사용하세요.

---

### 이 앱을 사용해야 할 때 (그리고 사용하지 말아야 할 때)

**다음 경우에 이 앱을 사용하세요:**
* 예후/예측 분야에서 후향적 또는 전향적 코호트 연구 계획
* 위험 예측 모델 개발 또는 검증
* 유병률 또는 AUC의 정밀도 (신뢰구간 너비)에 따른 표본 크기 추정
* 보정 및 판별력 목표를 가진 외부 검증 설계

**다음 경우에는 주요 도구로 이 앱을 사용하지 마세요:**
* 무작위 대조 시험 (RCT) 설계 (RCT 전용 검정력/표본 크기 방법 사용)
* 예측 모델링 없이 민감도/특이도에 대한 진단 정확도 연구 계획
* 단일 "정확한" 숫자를 기대하는 경우: 표본 크기 계획은 가정에 의존하며 민감도 분석을 포함해야 함

---

### 이용 가능한 방법 (개요)

#### A. 빠른 / 기본 (신속, 근사)

**A1 — 경험적 규칙 (EPV/EPP) (휴리스틱)**
* **사용 시점:** 계획된 모델 크기에 대해 사건 수가 "대략 충분한지" 빠르게 확인할 때.
* **사용하지 말아야 할 경우:** 모델에 스플라인/상호작용/변수 선택이 포함되거나 사건 발생률이 낮은 경우—EPV/EPP는 좋은 보정 또는 낮은 낙관주의를 보장하지 않음.
* **주요 입력:** 사건 발생률 $p$, 파라미터 수 $P$ (df), 목표 EPP (예: 10/15/20)
* **핵심 출력:** 필요 사건 수 $E=t \\cdot P$, 필요 표본 크기 $N=\\lceil E/p \\rceil$
* **장점:** 매우 간단함; 초기 타당성 검토에 적합
* **단점:** 오해의 소지가 있음; 성능 기반이 아님

**A2 — 기준 위험 정밀도 (유병률에 대한 CI 너비)**
* **사용 시점:** 목표가 원하는 CI 반폭 (예: ±2%)으로 사건 발생률 $p$를 추정하는 것일 때.
* **사용하지 말아야 할 경우:** 예측 모델 성능 보장 (AUC/보정 기울기)을 원할 때.
* **주요 입력:** 예상 $p$, CI 방법 (Wilson 권장), 신뢰 수준, 목표 반폭 $d$
* **핵심 출력:** CI 반폭 $\\le d$를 충족하는 최소 $N$
* **장점:** 직접적인 정밀도 목표; 투명한 가정
* **단점:** 유병률에만 해당, 모델 성능은 아님

#### B. 예후 인자 (검정력) (연관성 중심, 예측 모델 크기 결정 아님)

**B3 — 로지스틱 OR 검정력 (Hsieh)**
* **사용 시점:** 로지스틱 회귀에서 예후 인자에 대한 목표 오즈비 (OR) 검출 검정력이 필요할 때.
* **사용하지 말아야 할 경우:** 주요 목표가 예측 모델 개발 (보정/판별력)일 때, 가설 검정이 아닐 때.
* **주요 입력:** 기준 위험 $p_0$, 목표 OR, 알파, 검정력, 노출 유병률 (이분형) 또는 SD (연속형), 선택적 공변량과의 $R^2$
* **핵심 출력:** OR 검출에 필요한 $N$ (및 암시된 사건 수)
* **장점:** 연관성에 대한 고전적 검정력 프레임워크
* **단점:** 예측 모델 성능을 다루지 않음; 입력 가정에 민감

**B4 — Cox HR 검정력 (Schoenfeld)**
* **사용 시점:** 생존 시간 결과; Cox 비례위험 하에서 위험비 (HR) 검출 검정력이 필요할 때.
* **사용하지 말아야 할 경우:** 비례위험 가정이 위반될 가능성이 높거나, 사건 분율이 매우 불확실하여 합리적으로 추정할 수 없을 때.
* **주요 입력:** HR, 알파, 검정력, 배분 비율 (이분형) 또는 SD (연속형), 추적 기간 동안 예상 사건 분율
* **핵심 출력:** 필요 사건 수; 사건 분율을 사용하여 $N$으로 변환
* **장점:** 널리 인정됨; 사건 기반 계획이 직관적
* **단점:** 사건 분율 및 추적/중도절단 가정에 강하게 의존

#### C. 예측 모델 개발 (위험 모델 구축에 권장)

**C5 — Riley 등 (분석적; pmsampsize 유사)**
* **사용 시점:** 다변량 예측 모델 개발; 과적합 제어 및 적절한 정밀도 보장이 필요할 때.
* **사용하지 말아야 할 경우:** 유병률 및 예상 모델 성능 (AUC 또는 $R^2$)에 대한 합리적인 가정을 제공할 수 없을 때; 이 경우 민감도 분석 또는 시뮬레이션 사용.
* **주요 입력:** 사건 발생률 $p$, 파라미터 $P$ (df), 목표 수축 (예: 0.90), 예상 모델 성능 (AUC 또는 Cox–Snell $R^2$)
* **핵심 출력:** 여러 기준 충족 최소 $N$ (과적합 제어 + 정밀도)
* **장점:** 원칙에 기반, 성능 인식, 널리 인용됨
* **단점:** 성능 가정에 의존; 신중한 자유도 계산 필요

**C6 — 개발 시뮬레이션 (빈도주의; samplesizedev/사용자 정의 DGM)**
* **사용 시점:** "수행할 것을 시뮬레이션"하는 것을 선호, 특히 비선형성/상호작용 및 사용자 정의 데이터 구조가 있을 때.
* **사용하지 말아야 할 경우:** 그럴듯한 데이터 생성 메커니즘을 지정할 수 없거나 즉각적인 결과가 필요할 때.
* **주요 입력:** 후보 $N$ 그리드, DGM 가정, 성능 목표 (예: 보정 기울기 범위, AUC 임계값), 시뮬레이션 반복, 시드
* **핵심 출력:** 허용 가능한 확률/정밀도로 목표 달성하는 최소 $N$
* **장점:** 유연함; 복잡한 모델링과 일치
* **단점:** 가정에 크게 의존; 계산 비용

**C7 — 베이지안 보증 (MCMC)**
* **사용 시점:** 최종 모델이 베이지안 MCMC로 추정되고, 보증 기반 표본 크기가 필요할 때.
* **사용하지 말아야 할 경우:** 사전분포를 정당화할 수 없거나 계산 예산이 제한적일 때.
* **주요 입력:** DGM, 사전분포, 후보 $N$, MCMC 설정, 보증 임계값 (예: 80%/90%), 성능/정밀도 목표
* **핵심 출력:** 보증 임계값 충족 최소 $N$
* **장점:** 베이지안 워크플로우와 일관됨; 사후 기준 직접 목표
* **단점:** 계산 집약적; 사전분포 사양 필요

#### D. 검증 / 업데이트 (기존 모델용)

**D8 — AUC 정밀도 (Hanley–McNeil / presize)**
* **사용 시점:** 검증 목표가 AUC의 정밀도 (CI 너비)일 때.
* **사용하지 말아야 할 경우:** 보정 (기울기/CITL)이 주요 관심사일 때—이 방법은 AUC만 목표.
* **주요 입력:** 예상 AUC, 유병률 또는 환자-대조군 비율, 신뢰 수준, 목표 CI 너비
* **핵심 출력:** 원하는 AUC CI 너비 달성을 위한 최소 $N$
* **장점:** 간단함; 판별력 정밀도에 대한 빠른 계획
* **단점:** 근사 분산; 보정 무시

**D9 — 외부 검증 (맞춤형; pmvalsampsize / sampsizeval)**
* **사용 시점:** 여러 성능 측정을 목표로 하는 검증 크기 결정, 종종 LP 분포 가정 필요.
* **사용하지 말아야 할 경우:** LP 분포 가정을 정당화할 수 없을 때.
* **주요 입력:** 유병률, 예상 AUC, 보정 기울기/CITL 목표, CI 너비 또는 SE 목표, LP 분포 가정
* **핵심 출력:** 여러 측정에 대한 정밀도 기준 충족 권장 $N$
* **장점:** 맞춤형; 보정 인식
* **단점:** 추가 가정 필요; 더 복잡함

**D10 — 외부 검증 (시뮬레이션; LP 기반)**
* **사용 시점:** 목표 검증 집단에서 LP 분포를 지정/추정할 수 있고 시뮬레이션 기반 정밀도 계획을 원할 때.
* **사용하지 말아야 할 경우:** LP 분포가 알려지지 않고 근사할 수 없을 때.
* **주요 입력:** LP 분포 (정규/베타/경험적), 오보정 파라미터, 측정값에 대한 CI 너비 목표, 반복, 시드
* **핵심 출력:** 시뮬레이션 하에 정밀도 목표 달성 최소 $N$
* **장점:** 매우 유연함; "예상하는 것을 시뮬레이션"과 일치
* **단점:** 가정에 크게 의존; 계산 비용

**D11 — 업데이트 / 재보정 (절편/기울기)**
* **사용 시점:** 기존 모델을 재보정하고 적절한 정밀도가 필요할 때.
* **사용하지 말아야 할 경우:** 완전히 새로운 모델을 개발할 때 (C5–C7 사용).
* **주요 입력:** 업데이트 유형, 사건 발생률, 정밀도 목표
* **핵심 출력:** 안정적인 업데이트에 충분한 $N$
* **장점:** 실제 배포에 실용적
* **단점:** 지역 케이스 믹스 및 모델 이동성 가정에 의존

---

#### 면책 조항

임상적 보증 없음; 사용자는 검증 및 해석에 책임이 있습니다. 항상 가정을 문서화하고 민감도 분석을 수행하세요.

#### 연락처

저자 및 유지관리: Minh Nguyen (minhnt@ump.edu.vn)
""",

        "a2_content_md": """
### 개요

이 모듈은 **원하는 정밀도**(신뢰 구간(CI) 반폭 또는 오차 한계로 표현됨)로 **기본 위험 / 사건 발생률** ($p$)(즉, 결과의 유병률)을 추정하는 데 필요한 **최소 표본 크기($n$)**를 추정합니다.

다음과 같은 경우에 유용합니다:
* 지정된 정밀도로 코호트 내 결과 유병률 설명,
* 타당성 계획 및 기본 위험 보고,
* 보정(calibration) 관련 계획 지원 (예: calibration-in-the-large는 사건 발생률에 의존).

**중요한 제약 사항:** 이 계산은 예측 모델 성능(AUC, 보정 기울기, 낙관주의)을 **보장하지 않습니다**. 오직 ($p$) 추정의 정밀도만을 목표로 합니다.

---

### 입력 값 (의미)

1. **결과 유병률 / 사건 발생률** ($p$)
   대상 모집단에서 예상되는 사건 비율 (예: 0.10).
   * 알 수 없는 경우, 타당한 범위를 고려하여 민감도 분석을 실행하십시오.
   * 유병률 정밀도에 대해 보수적인 "최악의 경우"를 원한다면 ($p=0.50$)을 사용하십시오 (분산 최대화).

2. **목표 반폭 (오차 한계)** ($d$)
   CI가 대략 다음과 같도록 하는 원하는 정밀도:
   $p \\pm d$
   예: ($d = 0.01, 0.02, 0.03$) (즉, ±1%, ±2%, ±3%).

3. **신뢰 수준** ($1-\\alpha$)
   일반적인 값: 0.95 또는 0.99.

4. **CI 방법**
* **Wilson score (권장):** Wald보다 커버리지가 좋으며, 특히 ($p$)가 0이나 1에 가깝거나 표본 크기가 적당할 때 좋습니다.
* **Wald (정규 근사):** 간단한 폐쇄형이지만 ($n$)이 작거나 ($p$)가 극단적일 때 성능이 떨어질 수 있습니다.
* **Clopper–Pearson (정확):** 보수적입니다 (종종 더 넓은 CI를 산출하므로 더 큰 ($n$)이 필요함).

---

### 핵심 계산 (원리)

$X \\sim \\text{Binomial}(n,p)$, $\\hat p = X/n$이라고 합시다. 목표는 선택한 CI 방법이 다음을 산출하도록 하는 가장 작은 ($n$)을 찾는 것입니다:
$$
\\frac{\\text{Upper}(n) - \\text{Lower}(n)}{2} \\le d
$$

#### A) Wald (폐쇄형 근사)
$$ n \\approx \\frac{z^2 p(1-p)}{d^2} $$
**참고:** 빠르지만 ($n$)이 작거나 ($p$)가 극단적일 때는 권장되지 않습니다.

#### B) Wilson score 구간 (권장)
Wilson score 구간 공식을 사용합니다. 구간이 관측된 빈도 $x$에 따라 달라지므로, 예상되는 결과에 대해 반폭 제약 조건을 만족하는 가장 작은 $n$을 반복적으로 찾습니다.

#### C) Clopper–Pearson “정확” 구간
Beta 분위수를 사용합니다. 보수적인 방법입니다.

---

### 실용적인 기본값

* **신뢰 수준:** 95%가 표준입니다.
* **반폭 ($d$):** ±0.01 ~ ±0.03 (1%–3%)이 일반적인 목표입니다.
* **방법:** Wilson이 강력한 기본값입니다.

### 주요 참고 문헌
1. **Wilson EB.** Probable inference... *JASA.* 1927.
2. **Newcombe RG.** Two-sided confidence intervals... *Stat Med.* 1998.
""",

        "b3_content_md": """
### 목적 (이 방법의 정의)

이 모듈은 **로지스틱 회귀**를 사용하여 예측 변수 ($X$)와 **이분형 결과** ($Y$) 간의 연관성을 탐지하는 데 필요한 **최소 표본 크기**를 추정하며, 지정된 **오즈비(OR)**, **양측 검정 유의수준($\\alpha$)**, 및 **검정력(Power)**을 목표로 합니다.

이것은 **예후 인자 / 연관성 중심**의 검정력 계산(회귀 계수 검정)이며, 예측 모델 성능 방법이 **아닙니다**. 다변량 예측 모델의 좋은 보정이나 판별력을 **보장하지 않습니다**.

---

### 사용 시점

B3를 사용할 때:

* **단일 예측 변수** (이분형 또는 연속형)에 대해 로지스틱 회귀에서 **임상적으로 의미 있는 OR**을 탐지할 검정력을 원할 때.
* 주요 목표가 위험 예측 모델 구축이 아니라 **가설 검정** (예측 변수가 결과와 관련이 있는가?)일 때.

### 사용하지 말아야 할 때

B3를 주된 접근 방식으로 사용하지 마십시오:

* 목표가 **예측 모델 개발**일 때 (Riley/pmsampsize 또는 시뮬레이션/보증 방법 사용).
* **데이터 기반 변수 선택**, 많은 상호작용/스플라인 또는 복잡한 머신러닝 튜닝을 계획할 때 (단일 계수에 대한 검정력은 올바른 목표가 아닙니다).
* 데이터가 **군집화**되어 있거나 (다기관/병동 수준 상관관계) 디자인 효과 조정 없이 강하게 의존적인 경우.
* 고정된 환자/대조군 샘플링을 사용하는 **환자-대조군(case-control)** 디자인인 경우 (기본 위험($p_0$)이 원 모집단을 대표하지 않을 수 있음).

---

### 통계 모델 및 파라미터

로지스틱 회귀 모델:
$$
\\text{logit}{P(Y=1\\mid X)}=\\beta_0+\\beta_1 X
$$

* **이분형** ($X\\in\\{0,1\\}$)인 경우:
  $$
  \\mathrm{OR}=\\exp(\\beta_1)
  $$
* **연속형** ($X$)인 경우: OR은 ($X$)의 특정 변화에 대해 정의되어야 하며, 일반적으로 **1 표준편차(SD) 증가**입니다.

가설 검정:
$$
H_0:\\beta_1=0 \\quad \\text{vs}\\quad H_1:\\beta_1\\neq 0
$$

---

### 입력 값 (의미)

1. **알파 (양측)** ($\\alpha$)
   일반적인 선택: 0.05 (표준), 0.01 (더 엄격함).

2. **검정력** ($1-\\beta$)
   일반적인 선택: 0.80 (표준), 0.90 (보수적).

3. **기본 사건 발생률** ($p_0$)

   * **이분형 예측 변수**: ($p_0 = P(Y=1\\mid X=0)$) (참조 그룹의 사건 발생률).
   * **연속형 예측 변수**: ($p_0$)는 일반적으로 ($X$)의 **평균**에서의 사건 발생률로 해석됩니다 (중심화 후).

4. **목표 오즈비** ($\\mathrm{OR}$)
   임상적으로 의미 있고 탐지할 가치가 있는 가장 작은 OR입니다.

5. **예측 변수 유형**

* **이분형 예측 변수**: **($X=1$)의 유병률**이 필요하며, ($q=P(X=1)$)로 표시합니다.
* **연속형 예측 변수**: 일반적으로 **1 SD 증가**에 대한 OR이 필요합니다 (또는 SD를 사용하여 변환해야 함).

6. **다른 공변량과의 ($R^2$)**
   다변량 모델에서 ($X$)를 다른 공변량에 대해 회귀했을 때의 다중 상관 계수 제곱입니다.

   * ($X$)가 다른 예측 변수와 상관관계가 있으면 ($\\beta_1$)에 대한 유효 정보가 감소하므로 필요한 표본 크기가 증가합니다.

---

### 계산 방식

#### 1단계 — OR과 기본 위험을 ($p_1$)으로 변환 (이분형 ($X$))

($X$)가 이분형인 경우, ($p_0$)와 OR로부터 노출 그룹의 사건 발생률 ($p_1=P(Y=1\\mid X=1)$)을 계산합니다:

$$
\\text{odds}_0=\\frac{p_0}{1-p_0},\\quad \\text{odds}_1=\\mathrm{OR}\\cdot \\text{odds}_0,\\quad
p_1=\\frac{\\text{odds}_1}{1+\\text{odds}_1}
$$

전체 사건 발생률:
$$
p=(1-q)p_0+q p_1
$$

#### 2단계 — Z-점수

$$
z_{\\alpha}=z_{1-\\alpha/2}, \\qquad z_{\\beta}=z_{1-\\beta}=z_{\\text{power}}
$$

#### A) 이분형 예측 변수 표본 크기 (Hsieh 접근법)

$$
n_0=
\\frac{
\\left[
z_{\\alpha}\\sqrt{\\frac{p(1-p)}{q(1-q)}}
+
z_{\\beta}\\sqrt{\\frac{p_1(1-p_1)}{q}+\\frac{p_0(1-p_0)}{1-q}}
\\right]^2
}
{(p_1-p_0)^2}
$$

**다른 공변량과의 상관관계 보정:**

관심 예측 변수 ($X$)가 다른 공변량과 상관관계가 있는 다변량 모델을 계획하는 경우, 다음을 사용하여 표본 크기를 부풀립니다:

$$
n=\\frac{n_0}{1-R^2}
$$

**예상 사건 수:**

$$
E \\approx n\\cdot p
$$

---

#### B) 연속형 예측 변수 표본 크기 (Hsieh 접근법)

연속형 예측 변수 ($X$)가 있는 로지스틱 모델을 가정하고 ($X$)의 **1 SD 증가**에 대한 OR을 ($\\mathrm{OR}_{SD}$)라고 정의합니다. ($p_0$)를 ($X$)의 평균에서의 사건 발생률이라고 합시다:

$$
n_0=\\frac{(z_{\\alpha}+z_{\\beta})^2}{p_0(1-p_0) [\\log(\\mathrm{OR}_{SD})]^2}
$$

사용자가 1단위 증가당 OR ($\\mathrm{OR}_{unit}$)을 가지고 있고 ($X$)의 SD가 ($\\sigma_X$)인 경우 변환합니다:
$$
\\log(\\mathrm{OR}_{SD})=\\log(\\mathrm{OR}_{unit})\\cdot \\sigma_X
$$

그런 다음 동일한 다변량 상관관계 팽창을 적용합니다:
$$
n=\\frac{n_0}{1-R^2}
$$

---

### 실용적인 가이드: 값 선택 (일반적인 관례)

* **($\\alpha$):** 0.05 (양측)가 일반적입니다. 다중 검정이 예상되면 더 작게 사용하십시오.
* **검정력(Power):** 0.80이 일반적입니다. 효과를 놓치는 비용이 클 경우 0.90이 선호됩니다.
* **OR:** **최소한 임상적으로 의미 있는** OR을 선택하십시오 (상황에 따라 주로 1.2–2.0 범위).
* **기본 위험 ($p_0$):** 가능한 경우 지역 병원/코호트 데이터를 사용하고, 그렇지 않으면 문헌 추정치를 사용하고 민감도 분석을 실행하십시오.
* **이분형 예측 변수 유병률 ($q$):** 지역 유병률을 사용하십시오. ($q$)가 0.5에 가까울수록 **가장 큰 정보**를 제공합니다 (더 작은 ($n$)); ($q$)가 매우 작거나 크면 필요한 ($n$)이 증가합니다.
* **($R^2$):** 불확실한 경우 민감도 범위를 실행하십시오 (예: 0, 0.1, 0.25, 0.5). 중간 정도의 상관관계라도 ($1/(1-R^2)$)를 통해 ($n$)을 상당히 증가시킬 수 있습니다.
* **연속형 예측 변수:** ($\\mathrm{OR}_{SD}$)를 해석하기 쉽도록 ($X$)를 평균 0, SD 1로 표준화하는 것을 고려하십시오.

---

### 주요 참고 문헌
1. Hsieh FY, et al. *Stat Med.* 1998.
2. Hsieh FY. *Stat Med.* 1989.
3. Whittemore AS. *JASA.* 1981.
""",
        "c5_content_md": r"""
### 이 방법은 무엇입니까

C5는 **이분형 결과**(로지스틱 회귀)를 가진 **다변량 임상 예측 모델 개발**을 위한 **Riley 등의 분석적 최소 표본 크기 기준**을 구현합니다. 목표는 개발 데이터 세트가 충분히 커서 다음을 보장하는 것입니다:

1. **과적합(Overfitting) 제한** (목표하는 전체 수축(shrinkage) / 보정 기울기를 통해),
2. 모델 성능에 대한 **적절한 정밀도 달성** ($R^2$의 낙관주의에 대한 경계 설정),
3. **전체 결과 위험**(절편/기본 위험)을 수용 가능한 정밀도로 추정.

이것은 **모델 개발** 방법입니다 (외부 검증 아님). **미리 지정된 모델 형태**(예측 변수 및 코딩이 미리 정의됨)를 계획하고 **EPV 규칙에 대한 원칙적인 대안**을 원할 때 특히 적합합니다.

---

### 사용 시점

C5를 사용할 때:

* **이분형 결과**에 대한 새로운 예측 모델을 **개발**하고 있습니다.
* **사건 발생률**과 예상되는 **전체 모델 성능**(Cox–Snell $R^2$ 또는 AUC)을 (대략적으로라도) 지정할 수 있습니다.
* **낮은 과적합**(예: 수축 $S \ge 0.90$)과 합리적인 정밀도를 목표로 합니다.

### 사용하지 말아야 할 때 (또는 주의해서 사용)

다음의 경우 C5에만 의존하지 마십시오:

* 광범위한 **데이터 기반 변수 선택**, 다중 상호작용/스플라인, 또는 헤비한 머신러닝 튜닝을 **유효 파라미터 수(df)** 조정 없이 수행할 때.
* 데이터가 강력하게 **군집화**(다기관)되어 있고 디자인 효과를 고려하지 않을 때.
* 의도한 모델링 접근 방식이 표준 로지스틱 회귀가 아닌 경우 (예: 복잡한 ML), 복잡성을 적절한 **유효 df**로 매핑하거나 시뮬레이션 기반 크기 결정으로 전환해야 합니다.
* 그럴듯한 성능 입력(AUC/$R^2$)을 정당화할 수 없는 경우; 이 경우 광범위한 민감도 분석을 실행하고 시뮬레이션 기반 방법을 고려하십시오.

---

### 주요 입력 값 (의미)

1. **결과 유병률 / 사건 발생률** ($p$)
   개발 데이터 세트에서 ($Y=1$)인 예상 비율.

2. **예측 변수 파라미터 수 (df)** ($P$)
   **절편을 제외한** 모든 후보 예측 변수의 총 자유도.
   포함: 더미 변수, 스플라인 기저, 상호작용 (및 기타 기저 확장).

3. **예상 성능** (하나 선택)

* **Cox–Snell ($R^2_{CS}$)**: 관련 선행 연구에서 이용 가능한 경우 선호됨 (이상적으로는 낙관주의 조정됨).
* **AUC (C-통계량)**: $R^2_{CS}$를 이용할 수 없는 경우, 도구는 게시된 접근 방식을 사용하여 AUC와 ($p$)로부터 $R^2_{CS}$를 근사할 수 있습니다.
* **보수적 (최대 $R^2$의 15%)**: AUC나 $R^2$ 모두 이용할 수 없을 때의 대안; 주의해서 사용하십시오.

4. **목표 전체 수축 (S)**
   **전반적인 과적합 제어**를 위한 목표 (종종 내부 검증 후 예상되는 보정 기울기와 유사하게 해석됨).

* 일반적인 기본값: $S = 0.90$ (예측 효과의 약 10% 수축).
* 더 보수적: $S = 0.95$ (더 큰 표본 크기 필요).

---

### 핵심 개념 및 공식

#### Cox–Snell ($R^2$) 및 최대값

적합된 로지스틱 모델에 대한 Cox–Snell ($R^2$)는 다음과 같이 쓸 수 있습니다:
$$
R^2_{CS} = 1-\exp\left(\frac{2}{n}(\ell_0-\ell_1)\right),
$$
여기서 $\ell_0$는 절편만 있는 로그 우도이고 $\ell_1$은 모델 로그 우도입니다.

이분형 결과의 경우, $R^2_{CS}$는 1에 도달할 수 없습니다. 최대값은 결과 유병률에 따라 달라집니다:
$$
\ell_0 = n\Big[p\ln(p) + (1-p)\ln(1-p)\Big],
$$
$$
R^2_{CS,\max}=1-\exp\left(\frac{2\ell_0}{n}\right)
=1-\exp\Big(2[p\ln(p) + (1-p)\ln(1-p)]\Big).
$$

Nagelkerke ($R^2$)는 Cox–Snell ($R^2$)를 ([0,1])로 재조정합니다:
$$
R^2_{Nag}=\frac{R^2_{CS}}{R^2_{CS,\max}}.
$$

---

### 세 가지 Riley 기준 (이분형 결과)

#### 기준 1 — 목표 수축(S)을 통한 과적합 제어

목표 전체 수축(S)을 위한 최소 표본 크기:
$$
n_1=\left\lceil
\frac{P}{(S-1)\ln\left(1-\frac{R^2_{CS}}{S}\right)}
\right\rceil.
$$

#### 기준 2 — ($R^2$)의 낙관주의 제한 (기본 절대 차이 0.05)

이 기준은 겉보기(apparent)와 조정된(adjusted) **Nagelkerke** ($R^2$) 간의 작은 절대 차이(기본값 $\delta=0.05$)를 목표로 합니다. 이 제약 조건이 암시하는 필요 수축은 다음과 같습니다:
$$
S_{\delta}=\frac{R^2_{CS}}{R^2_{CS}+\delta R^2_{CS,\max}}.
$$
그러면:
$$
n_2=\left\lceil
\frac{P}{(S_{\delta}-1)\ln\left(1-\frac{R^2_{CS}}{S_{\delta}}\right)}
\right\rceil.
$$

#### 기준 3 — 전체 결과 위험(절편)의 정밀한 추정

이것은 확률 척도에서 ($\pm d$) 내의 **평균 결과 위험** ($p$) (기본 위험)의 정밀도를 목표로 합니다 (기본값 95% CI에서 $d=0.05$):
$$
n_3=\left\lceil
\left(\frac{z_{1-\alpha/2}}{d}\right)^2 p(1-p)
\right\rceil,
\quad \text{기본값 } z_{0.975}=1.96,; d=0.05.
$$

#### 최종 권장 사항

$$
n_{\min}=\max(n_1,n_2,n_3),\qquad
E = n_{\min}p,\qquad
EPP=\frac{E}{P}.
$$

---

### 실용적인 가이드 (일반적인 선택)

* **수축 (S)**: **0.90**을 표준 목표로 사용하십시오. 더 강력한 과적합 제어를 원하거나 모델이 복잡한 경우 **0.95**를 고려하십시오.
* **$\delta=0.05$** (기준 2): 일반적으로 기본값으로 유지됩니다.
* **절편 정밀도 (d=0.05)**: 기본값은 기본 위험을 ±5% 내에서 추정하는 것에 해당합니다. 기본 위험을 더 정밀하게 추정해야 하는 경우 더 작은 ($d$) (더 큰 ($n$))가 필요합니다.
* **예상 ($R^2_{CS}$)**:

  * 관련 연구의 **낙관주의 조정된** 값(또는 외부 검증 데이터의 겉보기 값)을 선호합니다.
  * AUC만 이용 가능한 경우, 게시된 AUC→$R^2_{CS}$ 근사 방법을 사용하십시오.
  * 둘 다 이용할 수 없는 경우, **$R^2_{CS,\max}$의 15%** 옵션은 탐색적 계획을 위한 보수적인 대안입니다—항상 민감도 분석을 실행하십시오.

---

### 주요 참고 문헌
1. Riley RD, et al. *Stat Med.* 2019.
2. Riley RD, et al. *BMJ.* 2020.
3. Riley RD, et al. *Stat Med.* 2021.
4. Harrell FE Jr, et al. *Stat Med.* 1996.
""",
        "c6_content_md": r"""
## C6: 개발 시뮬레이션 (빈도주의; 사용자 정의 DGM)


C6는 **예측 모델 개발**(이분형 결과)을 위한 **시뮬레이션 기반 표본 크기 계획** 접근 방식이며, **samplesizedev** 및 더 광범위한 시뮬레이션 기반 설계 원칙의 철학에서 영감을 받았습니다.

이것은 단일 분석 공식에 의존하는 대신 다음과 같이 질문합니다:

> “만약 우리가 계획된 접근 방식을 사용하여 크기 (N)의 데이터 세트에서 모델을 반복적으로 개발한다면, 새로운 데이터에서 모델이 사전 지정된 성능 기준을 얼마나 자주 충족할 것인가?”

따라서 예상되는 임상 모집단을 나타내는 **데이터 생성 메커니즘(DGM)** 하에서 **기대 성능**(및/또는 수용 가능한 성능의 확률)을 목표로 합니다.

---

## 사용 시점

C6를 사용할 때:

* 다음과 같은 경우 “**수행할 작업을 시뮬레이션**”하는 계획 방법과 일치하기를 원할 때:

  * 예측 변수가 상관관계가 있을 수 있음,
  * 비선형 항이나 상호작용을 포함함,
  * 사건 발생률이 적당하거나 불확실함,
  * **보정(calibration)** 및 **판별력(discrimination)**에 기반한 기준을 원함.
* 로컬 데이터나 문헌을 사용하여 합리적인 DGM을 지정할 수 있습니다.
* 시뮬레이션에 익숙하고 순수 분석적 크기 결정에 대한 더 유연한 대안을 원합니다.

## 사용하지 말아야 할 때 (또는 주의해서 사용)

다음의 경우 C6에만 의존하지 마십시오:

* 그럴듯한 DGM(예측 변수 분포, 상관관계, 효과 크기)을 정당화할 수 없을 때.
* 계산 예산이 없을 때 (시뮬레이션은 비용이 많이 들 수 있음).
* 전체 파이프라인을 명시적으로 시뮬레이션하지 않고 고도로 데이터 적응적인 ML 파이프라인(특징 선택, 복잡한 튜닝)을 계획할 때 (C6는 유효하려면 실제 파이프라인을 반영해야 함).
* 대상 모집단이 병원/센터 간에 이질적이며 군집화/케이스 믹스 변화를 시뮬레이션하지 않는 경우.

---

# 알고리즘 개요

각 후보 표본 크기 (N)에 대해, (R)개의 개발 데이터 세트를 시뮬레이션하고, 계획된 모델을 적합하고, “새로운 데이터”에서 평가하고, 성능을 요약합니다.

### 1단계 — DGM 선택

예측 변수 (X)와 결과 (Y)가 생성되는 방식을 정의합니다.

전형적인 이분형 결과 DGM:
[
Y \mid X \sim \text{Bernoulli}(\pi), \qquad
\pi = \text{logit}^{-1}(\eta),
]
[
\eta = \beta_0 + \sum_{j=1}^{P}\beta_j f_j(X_j),
]
여기서:

* (P)는 적합된 모델에서 사용된 **파라미터 수/df**,
* (f_j(\cdot))는 코딩 선택(선형 항, 스플라인 기저, 더미 코딩 등)을 나타냅니다.

목표 사건 발생률 (p)를 달성하기 위해, 다음이 되도록 (\beta_0)를 선택합니다:
[
\mathbb{E}[\pi] = p.
]
실제로 (\beta_0)는 (X)의 몬테카를로 추출을 사용한 수치적 루트 찾기로 찾습니다.

### 2단계 — 개발 데이터 세트 생성

반복 (r)에 대해:

* 선택한 예측 변수 분포(지정된 상관관계 포함)에서 크기 (N)의 (X^{(r)})을 시뮬레이션합니다.
* 위의 Bernoulli 모델에서 (Y^{(r)})을 시뮬레이션합니다.

### 3단계 — 개발 모델 적합

계획된 로지스틱 회귀 모델을 적합합니다:
[
\widehat{\eta} = \widehat{\beta}_0 + \sum_{j=1}^{P}\widehat{\beta}_j f_j(X_j).
]
**중요:** 시뮬레이션은 의도한 개발 전략(예: 불이익(penalization), 사전 지정된 항)과 일치해야 합니다. 분리/비수렴이 발생하는 경우, 릿지 불이익(ridge-penalized) 대안이 종종 사용됩니다(그리고 계산되어 보고되어야 함).

### 4단계 — 새로운 데이터에서 평가

동일한 DGM에서 독립적인 테스트 세트(크기 (N_{\text{test}}), 종종 5000–10000과 같이 큼)를 생성하고 다음을 계산합니다:

**(a) 판별력 (AUC / C-통계량)**
[
\mathrm{AUC}=\Pr(\widehat{\eta}_1 > \widehat{\eta}_0),
]
무작위로 선택된 사례(case)가 비사례(non-case)보다 더 높은 예측 위험을 가질 확률입니다.

**(b) 보정 기울기 (Calibration slope)**
테스트 세트의 보정 모델에서 (b)를 추정합니다:
[
\text{logit}(Y) = a + b \cdot \text{logit}(\widehat{p}),
]
또는 선형 예측 변수를 사용하여 동등하게:
[
\text{logit}(Y) = a + b \cdot \widehat{\eta}.
]
여기서 (b\approx 1)은 좋은 보정을 나타내고, (b<1)은 과적합(예측이 너무 극단적임)을 시사합니다.

### 5단계 — 합격/불합격 기준 정의 및 성공률 계산

각 (N)에 대한 (R) 시뮬레이션 전체에서 다음을 계산합니다:

* 평균 보정 기울기:
  [
  \overline{b} = \frac{1}{R}\sum_{r=1}^R b^{(r)}.
  ]
* 기울기가 수용 가능한 범위 내에 있을 확률:
  [
  \widehat{\Pr}(b \in [L,U]) = \frac{1}{R}\sum_{r=1}^R \mathbf{1}{b^{(r)}\in[L,U]}.
  ]
* 평균 AUC:
  [
  \overline{\mathrm{AUC}}=\frac{1}{R}\sum_{r=1}^R \mathrm{AUC}^{(r)}.
  ]

선택한 모든 기준이 충족되면 후보 (N)은 “수용 가능”합니다. 예:

* (\overline{b} \ge 0.90)
* (\widehat{\Pr}(0.9 \le b \le 1.1) \ge 0.80)
* (\overline{\mathrm{AUC}} \ge \mathrm{AUC}_{\text{target}})

통과하는 **가장 작은** (N)을 선택하십시오.

---

# 앱의 입력 (찾는 곳, 일반적인 값)

### 1) 결과 유병률 / 사건 발생률 (p)

**의미:** 개발 코호트에서 예상되는 사건 비율.
**얻는 곳:** 지역 병원 발생률/유병률(최선), 레지스트리 데이터, 또는 유사한 환경의 선행 연구.
**일반적인 계획 범위:** 5%–15%가 많은 임상 상황에서 일반적입니다 (그러나 매우 다양함).
**팁:** 불확실한 경우, 타당한 범위에 대해 **민감도 분석**을 실행하십시오.

### 2) 예측 변수 파라미터 수 (df) (P)

**의미:** 다음을 포함한 총 자유도(절편 제외):

* 범주형 더미,
* 스플라인 기저,
* 상호작용,
* 기타 추가 엔지니어링 항.
  **얻는 곳:** *최종* 계획된 모델 사양 (TRIPOD 스타일 사전 사양).
  **일반적인 값:** 10–30 df가 일반적입니다; 더 높으면 더 강력한 증거와 더 큰 표본이 필요합니다.

### 3) 목표 평균 AUC (모드 A)

**의미:** 새로운 데이터에서의 예상 판별력 (낙관주의 조정됨).
**얻는 곳:** 유사한 모집단의 이전 모델, 파일럿 데이터, 또는 게시된 AUC (외부 검증된 AUC 선호).
**일반적인 값:** 0.70–0.85가 일반적입니다; >0.90은 드물고 종종 낙관적입니다.

### 4) 후보 표본 크기 (N)

그리드를 제공하십시오 (예: 1000, 1500, 2000, 3000, 5000).
**팁:** 합격/불합격 임계값이 교차되도록 더 작은 값과 더 큰 값을 포함하십시오.

### 5) (N)당 시뮬레이션 수: (R)

**해석:** 몬테카를로 반복.

* 데모: (R \approx 200) (빠름, 더 높은 몬테카를로 오차)
* 최종: (R \ge 1000) (더 안정적)
  통과 확률 (\hat{p})에 대한 몬테카를로 표준 오차는 다음과 같습니다:
  [
  \mathrm{MCSE}=\sqrt{\frac{\hat{p}(1-\hat{p})}{R}}.
  ]
  예: (\hat{p}=0.8)이고 (R=200)이면, MCSE ≈ 0.028.

### 6) 성능 기준 (합격/불합격)

* **평균 보정 기울기 ≥ 0.9**
  (일반적인 과적합 제어 임계값)
* **Pr(0.9 ≤ slope ≤ 1.1) ≥ 80%**
  (일반적인 “수용 가능한 보정” 확률 임계값)
* **평균 AUC ≥ target**
  (판별력 목표)

**임계값 얻는 곳:** 진료 지침, 선행 연구, 임상적으로 허용되는 것.
**일반적인 관례:** 기울기 범위 0.90–1.10 및 보증(assurance) 0.80은 계획에 자주 사용됩니다; 더 높은 확실성을 위해 0.90 보증을 사용하십시오.

---

# 장점과 단점

**장점**

* 유연성: 상관관계, 비선형 항, 현실적인 모델링 선택을 수용합니다.
* 새로운 데이터 성능 및 보정 동작을 직접 목표로 합니다.
* 본질적으로 민감도 분석을 지원합니다.

**단점**

* 결과는 DGM 가정에 따라 달라집니다 (쓰레기가 들어가면 쓰레기가 나옴).
* 계산 집약적입니다.
* 의도한 모델링 파이프라인 전체를 시뮬레이션해야 합니다. 그렇지 않으면 결과가 오해의 소지가 있을 수 있습니다.

---

## 주요 참고 문헌 (2–5)

1. Pavlou M, Ambler G, Seaman SR, et al. *How to develop a more accurate risk prediction model when there are few events.* BMJ. 2015.
2. Riley RD, Snell KIE, Ensor J, et al. *Minimum sample size required for developing a multivariable prediction model: Part II—binary and time-to-event outcomes.* Statistics in Medicine. 2019.
3. Pavlou M, et al. *Methodology and software for simulation-based sample size calculation in prediction modeling* (sampsize development/related work). Statistics in Medicine. 2021.
4. Steyerberg EW. *Clinical Prediction Models: A Practical Approach to Development, Validation, and Updating.* 2nd ed. Springer. 2019.
""",
    "c7_content_md": r"""
## C7: 베이지안 보증 (MCMC)

### 이 방법은 무엇입니까
**베이지안 보증(Bayesian assurance)**은 **베이지안 모델 개발**(여기서는 이분형 결과에 대한 베이지안 로지스틱 회귀)을 위한 표본 크기 계획에 대한 시뮬레이션 기반 접근 방식입니다.
"검정력(Power)"(빈도주의)을 목표로 하는 대신, 보증은 연구가 **사전 지정된 성공 기준**(예: 보정 및 판별력 임계값, 및/또는 사후 정밀도)을 충족할 **무조건부 확률(unconditional probability)**을 목표로 합니다.

쉽게 말해:
> "전체 연구(데이터 생성 + 베이지안 MCMC 적합)를 여러 번 반복한다면, 적합된 모델이 충분히 좋을 확률은 얼마입니까?"

---

### 사용 시점
C7을 사용할 때:
- 최종 분석이 **베이지안**이고 **MCMC**로 추정될 예정일 때.
- **성공 목표 확률**(예: ≥80% 또는 ≥90%)을 달성하기 위해 표본 크기를 선택하고 싶을 때.
- 다음 사항에 대해 합리적인 가정을 지정할 수 있을 때:
  - 병원 코호트의 사건 발생률,
  - 예측 변수 상관 구조 및 분포,
  - 그럴듯한 효과 크기 (로컬 파일럿 데이터 또는 문헌에서),
  - 회귀 계수에 대한 사전 분포(priors).

### 사용하지 말아야 할 때 (또는 주의해서 사용)
다음의 경우 C7에만 의존하지 마십시오:
- 사전 분포(priors)나 그럴듯한 **데이터 생성 메커니즘(DGM)**을 정당화할 수 없을 때.
- 계산 예산이 없을 때 (MCMC는 느리며; 결과는 MCMC 설정에 민감할 수 있음).
- 실제 개발 파이프라인에 시뮬레이션하지 않는 상당한 데이터 적응 단계(특징 선택, 헤비 튜닝)가 포함된 경우.
- 데이터가 군집화/다기관이지만 DGM이 군집화를 무시하는 경우 (필요한 N을 과소평가할 수 있음).

---

## 핵심 모델 및 DGM

### 베이지안 로지스틱 회귀 (분석 모델)
\[
Y_i \sim \text{Bernoulli}(\pi_i), \qquad
\text{logit}(\pi_i)=\beta_0 + \sum_{j=1}^{P}\beta_j f_j(X_{ij})
\]
- \(P\) = 예측 변수 파라미터 수 (자유도; **절편 제외**).
- \(f_j(\cdot)\)는 코딩 선택(선형 항, 더미, 스플라인 기저, 상호작용)을 나타냅니다.

**예시 사전 분포 (일반적인 약한 정보성 기본값):**
\[
\beta_j \sim \mathcal{N}(0,\sigma_\beta^2),\quad \sigma_\beta \in [1, 2.5],
\qquad \beta_0 \sim \mathcal{N}(0, 5^2)
\]
(앱은 고정된 사전 분포를 사용할 수 있습니다; 사용자는 그럴듯한 사전 분포에 대해 민감도 분석을 실행해야 합니다.)

### 예측 변수에 대한 DGM (예시 등상관)
앱이 단일 상관 파라미터 \(\rho\) (등상관)를 사용하는 경우:
\[
\mathrm{Corr}(X_j, X_k)=\rho \quad (j\neq k),
\qquad
\Sigma_{jk}=
\begin{cases}
1,& j=k\\
\rho,& j\neq k
\end{cases}
\]
예측 변수는 상관된 메커니즘(예: 가우시안 코풀라 / 다변량 정규 코어)에서 생성된 다음 필요에 따라 연속/이분형 예측 변수로 변환됩니다.

### 사건 발생률 설정
절편(또는 보정 상수)은 한계 사건 발생률이 목표 유병률과 일치하도록 선택됩니다:
\[
\mathbb{E}[\pi_i]=p
\]
이것은 일반적으로 \(X\)의 몬테카를로 추출을 사용하여 수치적으로 해결됩니다.

---

## "보증(Assurance)"의 의미 (핵심 공식)
정의:
- \(\theta\)는 DGM 하의 "참" 파라미터(효과 크기, 상관 구조 등)를 나타냅니다.
- \(y\)는 크기 \(N\)의 관측된 데이터 세트를 나타냅니다.
- \(S(y)\)는 성능/정밀도 기준이 충족되면 1인 **성공 지표(success indicator)**입니다.

**표본 크기 \(N\)에서의 보증:**
\[
\mathcal{A}(N)=\Pr(\text{Success at }N)
=\mathbb{E}_{\theta}\left[\mathbb{E}_{y\mid \theta,N}\left\{S(y)\right\}\right]
\]

**앱에서 사용되는 몬테카를로 추정치 (각 후보 \(N\)에 대해):**
\[
\widehat{\mathcal{A}}(N)=\frac{1}{R}\sum_{r=1}^{R} S\!\left(y^{(r)}\right)
\]
여기서 각 반복 \(r\)은 데이터 세트를 시뮬레이션하고, MCMC로 베이지안 모델을 적합하고, 성공 기준을 평가합니다.

몬테카를로 표준 오차 (안정성 해석에 도움):
\[
\mathrm{MCSE}\left(\widehat{\mathcal{A}}(N)\right)
=\sqrt{\frac{\widehat{\mathcal{A}}(N)\left[1-\widehat{\mathcal{A}}(N)\right]}{R}}
\]

**결정 규칙:**
다음과 같은 가장 작은 \(N\)을 선택하십시오:
\[
\widehat{\mathcal{A}}(N)\ge \mathcal{A}_\text{target}
\]
(예: 0.80 또는 0.90).

---

## 성공 기준 (일반적인 예)
앱은 다음 중 하나 이상을 구현할 수 있습니다 (사용자 선택 가능):
- 수용 가능한 범위 내의 **보정 기울기**:
  \[
  0.90 \le b \le 1.10
  \]
  여기서 \(b\)는 검증/테스트 데이터의 보정 모델에서 추정됩니다:
  \[
  \text{logit}(Y)=a + b\cdot \text{logit}(\widehat{p})
  \]
- **판별력** 임계값:
  \[
  \mathrm{AUC} \ge 0.75 \;(\text{또는 선택한 목표})
  \]
- **사후 정밀도** 목표, 예: 보정 기울기에 대한 95% 신용 구간 너비:
  \[
  \mathrm{Width}\left(\text{CrI}_{95\%}(b)\right) \le w
  \quad (\text{예: } w=0.20)
  \]

---

## 입력 가이드 (값 찾는 곳; 일반적인 선택)

### 1) 결과 유병률 (사건 발생률) \(p\)
**얻는 곳:** 지역 병원 코호트/레지스트리; 최근 후향적 데이터.
**일반적인 계획 범위:** 0.05–0.15가 많은 임상 환경에서 일반적이지만, 질병 상황에 맞게 사용하십시오.
**팁:** 불확실한 경우, 타당한 범위에 대해 민감도 분석을 실행하십시오.

### 2) 예측 변수 파라미터 수 (df) \(P\)
**얻는 곳:** 최종 확정된 모델 사양 (**변수**가 아닌 **파라미터** 수).
더미, 스플라인 기저, 상호작용을 포함하십시오. 절편은 제외하십시오.
**일반적인 범위:** 10–30 df가 일반적입니다; df가 클수록 훨씬 더 큰 \(N\)과 더 강력한 사전 정당성이 필요합니다.

### 3) 예측 변수 상관관계 \(\rho\)
**얻는 곳:** 파일럿/병원 데이터에서 추정 (후보 예측 변수의 상관 행렬).
알려지지 않은 경우, 민감도 분석을 사용하십시오 (예: \(\rho=0, 0.1, 0.3\)).
**일반적:** 약함~중간 정도의 상관관계(0–0.3)가 일반적입니다; 상관관계가 높으면 불안정성이 증가하고 필요한 \(N\)이 증가할 수 있습니다.

### 4) 후보 표본 크기 \(N\)
합격/불합격 경계를 교차할 만큼 충분히 넓은 그리드를 선택하십시오 (예: 500, 1000, 1500, 2000, …).
타당성 제약 조건(사용 가능한 차트/기록)에서 시작하여 위쪽으로 확장하십시오.

### 5) \(N\)당 시뮬레이션 수 (반복) \(R\)
- **데모:** 50–200 (빠름; 더 높은 MC 오차)
- **최종 계획:** ≥500–1000 (더 안정적인 보증 추정치)
MCSE를 사용하여 안정성을 판단하십시오.

### 6) 보증 임계값 \(\mathcal{A}_\text{target}\)
- **0.80**: 타당성 중심 계획에 일반적
- **0.90**: 기준 충족에 더 높은 확신을 원할 때 선호됨

---

## 장점과 단점
**장점**
- 베이지안 워크플로와 완전히 일치합니다; **사후** 성공/정밀도를 직접 목표로 합니다.
- 유연성: 복잡한 DGM, 상관관계 및 성능 기반 기준을 수용합니다.
- 사전 지식을 통합하고 정규화 사전 분포를 통해 드문 사건을 현실적으로 처리할 수 있습니다.

**단점**
- 계산 집약적입니다; 결과는 MCMC 설정 및 수렴에 따라 달라질 수 있습니다.
- DGM 및 사전 가정에 민감함 → 민감도 분석이 필요합니다.
- 과소/과대 평가를 피하기 위해 실제 계획된 파이프라인을 시뮬레이션해야 합니다.

---

## 주요 참고 문헌 (2–5)
1) O'Hagan A. Assurance in clinical trial design. *Pharmaceutical Statistics.* 2005.
2) Pan J, Banerjee S. bayesassurance: An R Package for Calculating Sample Size and Bayesian Assurance. *The R Journal.* 2023.
3) Gelman A, Jakulin A, Pittau MG, Su Y-S. A weakly informative default prior distribution for logistic and other regression models. *The Annals of Applied Statistics.* 2008.
4) Sahu SK, Smith TMF. Bayesian methods of sample size determination. *Statistical Methodology / related Bayesian SSD literature.* 2006.
""",
        # Email & Reporting
        "report_header": "보고서 및 다운로드",
        "btn_download_report": "보고서 다운로드 (텍스트)",
        "btn_download_html": "보고서 다운로드 (HTML 형식)",
        "btn_download_csv": "결과 다운로드 (CSV)",
        "report_title": "표본 크기 계산 보고서",
        "footer_text": "저자 및 관리자: Minh Nguyen (minhnt@ump.edu.vn) Department of Epidemiology, Faculty of Public Health, University of Medicine and Pharmacy at Ho Chi Minh City, Vietnam",
        "btn_refresh": "새로 고침 / 초기화",
        "email_header": "이메일로 결과 보내기",
        "email_to": "수신자 이메일",
        "email_send_btn": "이메일 보내기",
        "email_success": "이메일 전송 성공!",
        "email_error": "이메일 전송 오류:",
        "email_settings": "이메일 설정 (SMTP)",
        "email_sender": "보내는 사람 이메일",
        "email_password": "앱 비밀번호",
        "email_subject_default": "표본 크기 분석 결과",
}
